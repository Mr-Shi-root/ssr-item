# ç¼“å­˜æ›´æ–°ç­–ç•¥è¯´æ˜

## é—®é¢˜èƒŒæ™¯

å•†å“è¯¦æƒ…é¡µä½¿ç”¨äº† LRU ç¼“å­˜æ¥æå‡ SSR æ€§èƒ½ï¼Œä½†å­˜åœ¨ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼š
- å•†å®¶æ›´æ–°å•†å“ä¿¡æ¯ï¼ˆä»·æ ¼ã€åº“å­˜ã€æè¿°ç­‰ï¼‰
- ç¼“å­˜è¿˜æœªè¿‡æœŸï¼ˆTTL 60ç§’ï¼‰
- ç”¨æˆ·çœ‹åˆ°çš„æ˜¯æ—§æ•°æ® âŒ

## è§£å†³æ–¹æ¡ˆï¼šRedis Pub/Sub æ¶ˆæ¯é˜Ÿåˆ—

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•†å“ç®¡ç†æœåŠ¡        â”‚         â”‚   SSR æœåŠ¡ (æœ¬é¡¹ç›®)  â”‚
â”‚  (å¯èƒ½æ˜¯å…¶ä»–é¡¹ç›®)    â”‚         â”‚                     â”‚
â”‚                     â”‚         â”‚                     â”‚
â”‚  æ›´æ–°å•†å“æ•°æ®        â”‚         â”‚  è®¢é˜…æ¶ˆæ¯            â”‚
â”‚       â†“             â”‚         â”‚       â†“             â”‚
â”‚  å‘å¸ƒæ¶ˆæ¯åˆ° Redis   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  æ”¶åˆ°æ¶ˆæ¯            â”‚
â”‚  publish()          â”‚  Redis  â”‚       â†“             â”‚
â”‚                     â”‚  Pub/Subâ”‚  æ¸…é™¤ LRU ç¼“å­˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜ç‚¹

âœ… **è§£è€¦**ï¼šå•†å“æœåŠ¡ä¸éœ€è¦çŸ¥é“ SSR æœåŠ¡çš„å­˜åœ¨
âœ… **åˆ†å¸ƒå¼**ï¼šå¤šå° SSR æœåŠ¡å™¨éƒ½èƒ½æ”¶åˆ°é€šçŸ¥
âœ… **å®æ—¶æ€§**ï¼šå•†å“æ›´æ–°åç«‹å³æ¸…é™¤ç¼“å­˜
âœ… **æ— ä¾µå…¥**ï¼šä¸éœ€è¦ä¿®æ”¹å•†å“æœåŠ¡çš„æ ¸å¿ƒé€»è¾‘

## å®ç°ç»†èŠ‚

### 1. SSR æœåŠ¡ï¼ˆè®¢é˜…è€…ï¼‰

æ–‡ä»¶ï¼š`src/server/index-with-lru.js`

```javascript
// åˆ›å»º Redis è®¢é˜…å®¢æˆ·ç«¯
const subscriber = new Redis({...});

// è®¢é˜…å•†å“æ›´æ–°æ¶ˆæ¯
subscriber.subscribe('item:updated');

// æ”¶åˆ°æ¶ˆæ¯åæ¸…é™¤ç¼“å­˜
subscriber.on('message', (channel, message) => {
  const { itemId } = JSON.parse(message);
  invalidateCache(itemId); // åˆ é™¤ LRU ç¼“å­˜
});
```

### 2. å•†å“ç®¡ç†æœåŠ¡ï¼ˆå‘å¸ƒè€…ï¼‰

æ–‡ä»¶ï¼š`src/examples/item-update-publisher.js`ï¼ˆç¤ºä¾‹ä»£ç ï¼‰

```javascript
// åœ¨å•†å“æ›´æ–°æ¥å£ä¸­
async function updateItem(itemId, data) {
  // 1. æ›´æ–°æ•°æ®åº“
  await db.update(itemId, data);

  // 2. å‘å¸ƒæ¶ˆæ¯
  await redis.publish('item:updated', JSON.stringify({ itemId }));
}
```

## ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨ SSR æœåŠ¡

```bash
# ç¡®ä¿ Redis å·²å¯åŠ¨
redis-server

# å¯åŠ¨ SSR æœåŠ¡ï¼ˆä¼šè‡ªåŠ¨è®¢é˜…æ¶ˆæ¯ï¼‰
npm run dev:lru
```

### æµ‹è¯•ç¼“å­˜æ›´æ–°

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•è„šæœ¬
node src/examples/item-update-publisher.js
```

ä½ ä¼šçœ‹åˆ°ï¼š
1. å‘å¸ƒè€…è¾“å‡ºï¼š`âœ… å·²å‘å¸ƒå•†å“æ›´æ–°æ¶ˆæ¯: 123`
2. SSR æœåŠ¡è¾“å‡ºï¼š`ğŸ“¢ æ”¶åˆ°å•†å“æ›´æ–°é€šçŸ¥: 123` â†’ `ğŸ—‘ï¸ å·²æ¸…é™¤å•†å“ 123 çš„ SSR ç¼“å­˜`

## å•†å“ç®¡ç†æœåŠ¡é›†æˆæŒ‡å—

å¦‚æœä½ çš„å•†å“ç®¡ç†æœåŠ¡åœ¨å…¶ä»–é¡¹ç›®ä¸­ï¼Œåªéœ€è¦ï¼š

### æ­¥éª¤ 1ï¼šå®‰è£… Redis å®¢æˆ·ç«¯

```bash
npm install ioredis
```

### æ­¥éª¤ 2ï¼šåœ¨å•†å“æ›´æ–°æ¥å£ä¸­å‘å¸ƒæ¶ˆæ¯

```javascript
const Redis = require('ioredis');
const redis = new Redis({ host: '127.0.0.1', port: 6379 });

// åœ¨ä½ çš„å•†å“æ›´æ–°æ¥å£ä¸­
router.post('/admin/item/:id', async (req, res) => {
  const itemId = req.params.id;

  // æ›´æ–°æ•°æ®åº“
  await updateItemInDB(itemId, req.body);

  // å‘å¸ƒæ¶ˆæ¯ï¼ˆåªéœ€è¦è¿™ä¸€è¡Œï¼ï¼‰
  await redis.publish('item:updated', JSON.stringify({ itemId }));

  res.json({ success: true });
});
```

### æ­¥éª¤ 3ï¼šç¡®ä¿ Redis è¿æ¥é…ç½®ä¸€è‡´

ä¸¤ä¸ªæœåŠ¡éœ€è¦è¿æ¥åˆ°**åŒä¸€ä¸ª Redis å®ä¾‹**ï¼š

```bash
# .env æ–‡ä»¶
REDIS_HOST=127.0.0.1  # æˆ–è€…ä½ çš„ Redis æœåŠ¡å™¨åœ°å€
REDIS_PORT=6379
REDIS_PASSWORD=       # å¦‚æœæœ‰å¯†ç 
```

## é™çº§ç­–ç•¥

å³ä½¿æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç³»ç»Ÿä»ç„¶å¯ç”¨ï¼š

1. **TTL å…œåº•**ï¼šç¼“å­˜ä¼šåœ¨ 60 ç§’åè‡ªåŠ¨è¿‡æœŸ
2. **æ‰‹åŠ¨æ¸…é™¤**ï¼šæä¾›äº† API æ¥å£æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜
   ```bash
   curl -X POST http://localhost:3000/api/lru-cache/invalidate/123
   ```

## é¢è¯•è¦ç‚¹

### Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥è°ƒç”¨ SSR æœåŠ¡çš„ APIï¼Ÿ

**A:** å› ä¸ºï¼š
- å•†å“æœåŠ¡ä¸åº”è¯¥ä¾èµ– SSR æœåŠ¡ï¼ˆè§£è€¦åŸåˆ™ï¼‰
- å¦‚æœæœ‰å¤šå° SSR æœåŠ¡å™¨ï¼Œéœ€è¦è°ƒç”¨å¤šæ¬¡
- å¦‚æœ SSR æœåŠ¡æŒ‚äº†ï¼Œå•†å“æ›´æ–°ä¹Ÿä¼šå¤±è´¥

### Q2: ä¸ºä»€ä¹ˆä¸ç”¨ global è€Œç”¨ Redisï¼Ÿ

**A:**
- **å¤šè¿›ç¨‹é—®é¢˜**ï¼šNode.js cluster æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ª worker çš„ global æ˜¯ç‹¬ç«‹çš„
- **åˆ†å¸ƒå¼é—®é¢˜**ï¼šå¤šå°æœåŠ¡å™¨æ— æ³•å…±äº« global å¯¹è±¡
- **æŒä¹…åŒ–é—®é¢˜**ï¼šè¿›ç¨‹é‡å¯å global æ•°æ®ä¸¢å¤±

### Q3: å¦‚æœ Redis æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ

**A:**
- ç¼“å­˜æ›´æ–°æ¶ˆæ¯ä¼šä¸¢å¤±ï¼Œä½† TTL ä¼šå…œåº•ï¼ˆ60ç§’åè‡ªåŠ¨è¿‡æœŸï¼‰
- å¯ä»¥é…ç½® Redis å“¨å…µæˆ–é›†ç¾¤ä¿è¯é«˜å¯ç”¨
- å¯ä»¥é™çº§ä¸ºå®šæ—¶è½®è¯¢æ•°æ®åº“çš„æ–¹å¼

## æ‰©å±•æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ”¯æŒæ‰¹é‡æ›´æ–°

```javascript
// å‘å¸ƒæ‰¹é‡æ›´æ–°æ¶ˆæ¯
await redis.publish('item:batch-updated', JSON.stringify({
  itemIds: ['123', '456', '789']
}));

// SSR æœåŠ¡è®¢é˜…
subscriber.on('message', (channel, message) => {
  if (channel === 'item:batch-updated') {
    const { itemIds } = JSON.parse(message);
    itemIds.forEach(id => invalidateCache(id));
  }
});
```

### æ–¹æ¡ˆ 2ï¼šæ”¯æŒå…¨é‡åˆ·æ–°

```javascript
// å‘å¸ƒå…¨é‡åˆ·æ–°æ¶ˆæ¯ï¼ˆä¾‹å¦‚ï¼šä¿ƒé”€æ´»åŠ¨å¼€å§‹ï¼‰
await redis.publish('cache:clear-all', JSON.stringify({
  reason: 'promotion-started'
}));

// SSR æœåŠ¡æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
subscriber.on('message', (channel, message) => {
  if (channel === 'cache:clear-all') {
    ssrCache.clear();
  }
});
```

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡

```bash
curl http://localhost:3000/api/lru-stats
```

### æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜çš„å•†å“

```bash
curl http://localhost:3000/api/lru-cache/keys
```

### æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜

```bash
# æ¸…é™¤å•ä¸ªå•†å“
curl -X POST http://localhost:3000/api/lru-cache/invalidate/123

# æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
curl -X POST http://localhost:3000/api/lru-cache/clear
```

## æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆå®ç°äº†ï¼š
- âœ… å®æ—¶ç¼“å­˜æ›´æ–°
- âœ… æœåŠ¡è§£è€¦
- âœ… åˆ†å¸ƒå¼æ”¯æŒ
- âœ… é™çº§å…œåº•

ç¬¦åˆç”Ÿäº§ç¯å¢ƒçš„ç¼“å­˜ä¸€è‡´æ€§è¦æ±‚ã€‚
